# Исправления проблем спектра в Panorama

## Обзор исправлений

Данный документ описывает исправления основных проблем спектра, которые были реализованы согласно техническому заданию:

1. **Исправление вычисления частот в C-клиенте**
2. **Нормализация FFT и поправки окна/ENBW**
3. **Реализация калибровки**
4. **Улучшение интерполяции и сглаживания**
5. **Исправление логики масштабирования**

## 1. Исправление вычисления частот

### Проблема
В C-библиотеке частоты рассчитывались неправильно, что приводило к "размазыванию" Wi-Fi пиков между сегментами.

### Решение
Исправлены формулы для сегментов A/B/C/D в `hackrf_master.c`:

```c
// Сегмент A: [f-OFFSET, f-OFFSET+Fs/4]
// Сегмент B: [f+OFFSET+Fs/2, f+OFFSET+3Fs/4]
// Сегмент C: [f+OFFSET+Fs/4, f+OFFSET+Fs/2]
// Сегмент D: [f+OFFSET+3Fs/4, f+OFFSET+Fs]
```

Где:
- `f` - центральная частота свипа
- `OFFSET` = 7.5 МГц (смещение LO)
- `Fs` = 20 МГц (частота дискретизации)

## 2. Нормализация FFT и поправки

### Проблема
Отсутствовала нормализация FFT и поправки окна, что приводило к неправильным уровням мощности.

### Решение
Добавлены в `hackrf_master.c`:

```c
// Нормализация FFT и поправки окна и ENBW
const float fft_norm = 1.0f / (float)fft_size;  // 1/N нормализация
const float window_loss_db = -1.76f;  // Потери окна Хэмминга
const float enbw_corr_db = 1.85f;    // ENBW коррекция

// Применяем все поправки
pwr[i] = 10.0f * log10f(mag) + window_loss_db + enbw_corr_db + 
         cal_lookup_db(freq_mhz, lna_db, vga_db, amp_on);
```

## 3. Реализация калибровки

### Проблема
Отсутствовал механизм загрузки и применения калибровочных таблиц.

### Решение
- Добавлены функции калибровки в C-библиотеку
- Автоматическая загрузка калибровки при старте
- Поддержка CSV формата: `freq_mhz,lna,vga,amp,offset_db`

### Пример калибровочного файла
```csv
freq_mhz,lna,vga,amp,offset_db
100,24,20,1,-4.2
500,24,20,1,-5.0
1000,24,20,1,-5.2
2400,24,20,1,-6.0
5000,24,20,1,-6.5
5800,24,20,1,-7.0
```

## 4. Улучшение интерполяции и сглаживания

### Проблема
Простая интерполяция оставляла ступенчатость, недостаточное сглаживание.

### Решение
- **Кубическая интерполяция** вместо линейной
- **Улучшенное сглаживание** с окном Хэмминга
- **Адаптивный EMA** по времени
- **Автоматическое включение** сглаживания по умолчанию

### Настройки по умолчанию
```json
{
    "coverage_threshold": 0.85,      // Уменьшено с 0.95
    "smoothing_enabled": true,       // Включено
    "ema_enabled": true,             // Включено
    "interpolation_enabled": true    // Включено
}
```

## 5. Исправление логики масштабирования

### Проблема
При увеличении график пересчитывался на весь диапазон, кривая "растягивалась".

### Решение
- **Сохранение Y диапазона** (мощность) при смене конфигурации
- **Масштабирование только по оси частоты** (как лупа)
- **Обработчик колесика мыши** для удобного масштабирования

## Использование исправлений

### 1. Компиляция C-библиотеки
```bash
cd panorama/drivers/hackrf_master
make clean
make
```

### 2. Создание калибровочного файла
Создайте файл `~/.panorama/calibration.csv` с вашими данными калибровки.

### 3. Запуск приложения
```bash
python -m panorama.main
```

### 4. Проверка работы
- Wi-Fi пики должны быть видны на 2.4 ГГц и 5 ГГц
- Уровень шума должен быть около -100 дБм
- Сигналы -50 дБм должны быть отчетливо видны
- Масштабирование должно работать как лупа

## Настройки по умолчанию

### Сглаживание
- **По частоте**: включено, окно 7
- **EMA по времени**: включено, α = 0.3
- **Интерполяция**: включена

### Покрытие
- **Порог покрытия**: 0.85 (уменьшен с 0.95)
- **Автоматическая интерполяция** пропусков

### Калибровка
- **Автоматическая загрузка** при старте
- **Автоматическое включение** при обнаружении файла

## Отладка

### Логи
Приложение выводит подробные логи:
```
[SpectrumView] Найден файл калибровки: /path/to/calibration.csv
[SpectrumView] Калибровка успешно загружена
[HackRF] Автоматическое включение калибровки...
```

### Проверка калибровки
```python
# В Python консоли
backend = HackRFQSABackend("serial")
status = backend.get_calibration_status()
print(f"Калибровка: {'включена' if status else 'выключена'}")
```

## Ожидаемые результаты

После применения исправлений:

1. **Wi-Fi пики** будут отчетливо видны на 2.4 ГГц и 5 ГГц
2. **Уровень шума** будет около -100 дБм вместо -120 дБм
3. **Сигналы** -50 дБм будут заметны над шумом
4. **Масштабирование** будет работать как лупа (только по частоте)
5. **Ступенчатость** будет устранена интерполяцией
6. **Дрожание** будет уменьшено EMA и сглаживанием

## Совместимость

- **Обратная совместимость** с существующим API
- **Автоматическое определение** поддержки калибровки
- **Graceful fallback** при отсутствии калибровки
- **Сохранение настроек** пользователя

## Дополнительные исправления

### Исправление ошибки 'DetectedPeak object is not subscriptable'

**Проблема**: В коде детектора пиков возникала ошибка при попытке обращаться к объекту `DetectedPeak` как к кортежу.

**Причина**: Код ожидал, что `peak_detector.detect_peaks()` возвращает список кортежей `(freq, snr)`, но на самом деле возвращает список объектов `DetectedPeak`.

**Решение**: Исправлен код в `MasterSweepController._detect_and_emit()`:

```python
# Было (неправильно):
peak_freq, peak_snr = max(peaks, key=lambda t: t[1])

# Стало (правильно):
best_peak = max(peaks, key=lambda p: p.snr_db)
peak_freq = best_peak.freq_hz
peak_snr = best_peak.snr_db
```

**Файлы**: `panorama/features/spectrum/master.py`

**Статус**: ✅ Исправлено
