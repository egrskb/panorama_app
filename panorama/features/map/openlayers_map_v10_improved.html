<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ê–ù–û–†–ê–ú–ê RSSI - –¢—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–æ–≤</title>
    
    <!-- OpenLayers 10.6.0 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@10.6.0/dist/ol.js"></script>
    
    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è RSSI */
        .rssi-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 24px;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            min-width: 280px;
        }
        
        .control-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #3b82f6;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            font-size: 13px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #94a3b8;
            font-weight: 500;
        }
        
        .info-value {
            color: #f8fafc;
            font-weight: 600;
            font-size: 12px;
        }
        
        /* –õ–µ–≥–µ–Ω–¥–∞ –¥–ª—è –¥—Ä–æ–Ω–æ–≤ –∏ —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏ */
        .trilateration-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 24px;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            min-width: 260px;
        }
        
        .legend-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #f59e0b;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 14px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            transition: background 0.3s ease;
        }
        
        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .legend-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }
        
        .legend-text {
            color: #e2e8f0;
            font-weight: 500;
        }
        
        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 20px;
            padding: 24px;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            min-width: 320px;
        }
        
        .coord-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #22c55e;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .coord-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .coord-item:last-child {
            border-bottom: none;
        }
        
        .coord-label {
            color: #94a3b8;
            font-weight: 500;
        }
        
        .coord-value {
            color: #f8fafc;
            font-weight: 600;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            background: rgba(34, 197, 94, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        /* –°—Ç–∞—Ç—É—Å —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏ */
        .trilateration-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px;
            padding: 24px;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }
        
        .status-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #ef4444;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 14px 0;
            font-size: 14px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #94a3b8;
            font-weight: 500;
        }
        
        .status-value {
            color: #f8fafc;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            min-width: 60px;
            text-align: center;
        }
        
        .status-value.active {
            color: #065f46;
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        .status-value.warning {
            color: #92400e;
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .status-value.danger {
            color: #991b1b;
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes droneDetected {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .drone-pulse {
            animation: droneDetected 3s infinite;
        }
        
        .rssi-zone-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="rssi-controls">
        <div class="control-title">üì° RSSI –¢—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏—è</div>
        
        <div class="info-item">
            <span class="info-label">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</span>
            <span class="info-value">–î–µ—Ç–µ–∫—Ü–∏—è –¥—Ä–æ–Ω–æ–≤</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</span>
            <span class="info-value">–ú–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">–°–µ—Ç–∫–∞:</span>
            <span class="info-value">100–º –∏–Ω—Ç–µ—Ä–≤–∞–ª</span>
        </div>
    </div>
    
    <!-- –õ–µ–≥–µ–Ω–¥–∞ —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏ -->
    <div class="trilateration-legend">
        <div class="legend-title">üîç –û–±—ä–µ–∫—Ç—ã</div>
        
        <div class="legend-item">
            <div class="legend-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üéØ</div>
            <span class="legend-text">SDR –°—Ç–∞–Ω—Ü–∏–∏</span>
        </div>
        
        <div class="legend-item">
            <div class="legend-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">üõ∏</div>
            <span class="legend-text">–î—Ä–æ–Ω—ã / –¶–µ–ª–∏</span>
        </div>
        
        <div class="legend-item">
            <div class="legend-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üìç</div>
            <span class="legend-text">–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏</span>
        </div>
        
        <div class="legend-item">
            <div class="legend-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">üìä</div>
            <span class="legend-text">RSSI –ó–æ–Ω—ã</span>
        </div>
    </div>
    
    <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="coordinate-info">
        <div class="coord-title">üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="coord-item">
            <span class="coord-label">–û–ø–æ—Ä–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è:</span>
            <span class="coord-value" id="reference-coords">X: 0.0, Y: 0.0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–ú–∞—Å—à—Ç–∞–±:</span>
            <span class="coord-value" id="scale-value">1:1000</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–°–µ—Ç–∫–∞:</span>
            <span class="coord-value" id="grid-size">100–º</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–ö—É—Ä—Å–æ—Ä:</span>
            <span class="coord-value" id="cursor-position">X: 0, Y: 0</span>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏ -->
    <div class="trilateration-status">
        <div class="status-title">üìç –¢—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏—è</div>
        
        <div class="status-item">
            <span class="status-label">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –¥—Ä–æ–Ω–æ–≤:</span>
            <span class="status-value danger" id="active-drones">0</span>
        </div>
        
        <div class="status-item">
            <span class="status-label">SDR —Å—Ç–∞–Ω—Ü–∏–π –∞–∫—Ç–∏–≤–Ω–æ:</span>
            <span class="status-value active" id="sdr-stations">0</span>
        </div>
        
        <div class="status-item">
            <span class="status-label">–¢–æ—á–Ω–æ—Å—Ç—å:</span>
            <span class="status-value warning" id="trilateration-accuracy">‚Äî</span>
        </div>
        
        <div class="status-item">
            <span class="status-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:</span>
            <span class="status-value" id="update-rate">20 –ì—Ü</span>
        </div>
    </div>
    
    <script>
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏ ====================
        
        // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–µ–∫—Ü–∏—é –≤ –º–µ—Ç—Ä–∞—Ö —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ (0,0) –¥–ª—è –æ–ø–æ—Ä–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
        const projection = new ol.proj.Projection({
            code: 'local-meters',
            units: 'meters',
            extent: [-2000, -2000, 2000, 2000] // 4–∫–º x 4–∫–º –æ–±–ª–∞—Å—Ç—å
        });
        
        // –†–µ–∂–∏–º –∫–∞—Ä—Ç—ã - —Ç–æ–ª—å–∫–æ RSSI —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏—è
        let currentMapMode = 'rssi-trilateration';
        
        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏
        const mapStyles = {
            // –°—Ç–∏–ª—å –¥–ª—è SDR —Å—Ç–∞–Ω—Ü–∏–π (—É–ª—É—á—à–µ–Ω–Ω—ã–π –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏)
            sdrStation: function(feature) {
                const id = feature.get('id') || '';
                const isReference = id === 'slave0' || feature.get('is_reference');
                const isActive = feature.get('is_active') !== false;
                
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: isReference ? 20 : 16,
                        fill: new ol.style.Fill({ 
                            color: isReference ? 'rgba(251, 191, 36, 0.9)' : 
                                  isActive ? 'rgba(34, 197, 94, 0.8)' : 'rgba(156, 163, 175, 0.6)'
                        }),
                        stroke: new ol.style.Stroke({ 
                            color: isReference ? 'rgba(245, 158, 11, 1)' : 
                                  isActive ? 'rgba(22, 163, 74, 1)' : 'rgba(107, 114, 128, 1)',
                            width: isReference ? 4 : 3
                        })
                    }),
                    text: new ol.style.Text({
                        text: isReference ? 'üéØ ' + id.toUpperCase() : 'üì° ' + id.toUpperCase(),
                        font: 'bold 14px sans-serif',
                        fill: new ol.style.Fill({ color: '#ffffff' }),
                        stroke: new ol.style.Stroke({ color: '#000000', width: 3 }),
                        offsetY: -32
                    })
                });
            },
            
            // –°—Ç–∏–ª—å –¥–ª—è –¥—Ä–æ–Ω–æ–≤ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏)
            drone: function(feature) {
                const confidence = feature.get('confidence') || 0.5;
                const rssi = feature.get('rssi') || -100;
                const isTracked = feature.get('is_tracked') || false;
                
                // –¶–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ RSSI
                let color;
                if (confidence > 0.8) {
                    color = '#ef4444'; // –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                } else if (confidence > 0.5) {
                    color = '#f59e0b'; // –°—Ä–µ–¥–Ω—è—è
                } else {
                    color = '#6b7280'; // –ù–∏–∑–∫–∞—è
                }
                
                return new ol.style.Style({
                    image: new ol.style.RegularShape({
                        points: isTracked ? 6 : 4, // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö
                        radius: 14,
                        radius2: isTracked ? 10 : 8,
                        rotation: isTracked ? 0 : Math.PI / 4,
                        fill: new ol.style.Fill({ color: color }),
                        stroke: new ol.style.Stroke({ 
                            color: '#ffffff', 
                            width: isTracked ? 3 : 2
                        })
                    }),
                    text: new ol.style.Text({
                        text: `üõ∏ ${(confidence * 100).toFixed(0)}%\n${rssi.toFixed(0)}dBm`,
                        font: 'bold 11px monospace',
                        fill: new ol.style.Fill({ color: '#ffffff' }),
                        stroke: new ol.style.Stroke({ color: '#000000', width: 2 }),
                        offsetY: 30
                    })
                });
            },
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (–µ–ª–µ –≤–∏–¥–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è)
            gridStyle: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(59, 130, 246, 0.15)',
                    width: 1,
                    lineDash: [1, 4]
                })
            }),
            
            // –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            gridLabelStyle: function(text, x, y) {
                return new ol.style.Style({
                    text: new ol.style.Text({
                        text: text,
                        font: '11px monospace',
                        fill: new ol.style.Fill({ color: 'rgba(156, 163, 175, 0.7)' }),
                        stroke: new ol.style.Stroke({ color: 'rgba(15, 23, 42, 0.8)', width: 2 }),
                        offsetX: x > 0 ? 15 : (x < 0 ? -15 : 0),
                        offsetY: y > 0 ? -15 : (y < 0 ? 15 : -5),
                        textAlign: x > 0 ? 'left' : (x < 0 ? 'right' : 'center'),
                        textBaseline: 'middle'
                    })
                });
            },
            
            // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–æ–ø–æ—Ä–Ω–∞—è —Ç–æ—á–∫–∞)
            axisStyle: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(251, 191, 36, 0.6)',
                    width: 2
                })
            }),
            
            // –°—Ç–∏–ª—å –¥–ª—è RSSI –∑–æ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
            rssiZone: function(rssi) {
                const normalizedRssi = Math.max(0, Math.min(1, (rssi + 120) / 90));
                const alpha = Math.max(0.1, normalizedRssi * 0.5);
                let color;
                
                if (normalizedRssi > 0.7) {
                    color = `rgba(34, 197, 94, ${alpha})`; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–∏–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
                } else if (normalizedRssi > 0.4) {
                    color = `rgba(245, 158, 11, ${alpha})`; // –ñ–µ–ª—Ç—ã–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
                } else {
                    color = `rgba(239, 68, 68, ${alpha})`; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å–ª–∞–±–æ–≥–æ
                }
                
                return new ol.style.Style({
                    fill: new ol.style.Fill({ color }),
                    stroke: new ol.style.Stroke({
                        color: color.replace(/[\\d\\.]+\\)$/, '0.7)'),
                        width: 1,
                        lineDash: [3, 3]
                    })
                });
            }
        };
        
        // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        const sources = {
            stations: new ol.source.Vector(),
            drones: new ol.source.Vector(),
            trajectories: new ol.source.Vector(),
            coverage: new ol.source.Vector(),
            grid: new ol.source.Vector()
        };
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—É—é —Å–µ—Ç–∫—É —Å –ø–æ–¥–ø–∏—Å—è–º–∏
        function createCoordinateGrid() {
            const gridFeatures = [];
            const gridStep = 100; // 100 –º–µ—Ç—Ä–æ–≤
            const extent = [-2000, -2000, 2000, 2000];
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let x = extent[0]; x <= extent[2]; x += gridStep) {
                const line = new ol.geom.LineString([[x, extent[1]], [x, extent[3]]]);
                const feature = new ol.Feature({ 
                    geometry: line,
                    type: 'grid-line'
                });
                feature.setStyle(x === 0 ? mapStyles.axisStyle : mapStyles.gridStyle);
                gridFeatures.push(feature);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–µ–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–µ 100–º)
                if (x !== 0 && x % 100 === 0) {
                    const labelFeature = new ol.Feature({
                        geometry: new ol.geom.Point([x, 0]),
                        type: 'grid-label'
                    });
                    labelFeature.setStyle(mapStyles.gridLabelStyle(`${Math.abs(x)}–º`, x, 0));
                    gridFeatures.push(labelFeature);
                }
            }
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let y = extent[1]; y <= extent[3]; y += gridStep) {
                const line = new ol.geom.LineString([[extent[0], y], [extent[2], y]]);
                const feature = new ol.Feature({ 
                    geometry: line,
                    type: 'grid-line'
                });
                feature.setStyle(y === 0 ? mapStyles.axisStyle : mapStyles.gridStyle);
                gridFeatures.push(feature);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–µ–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–µ 100–º)
                if (y !== 0 && y % 100 === 0) {
                    const labelFeature = new ol.Feature({
                        geometry: new ol.geom.Point([0, y]),
                        type: 'grid-label'
                    });
                    labelFeature.setStyle(mapStyles.gridLabelStyle(`${Math.abs(y)}–º`, 0, y));
                    gridFeatures.push(labelFeature);
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Ü–µ–Ω—Ç—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const originLabel = new ol.Feature({
                geometry: new ol.geom.Point([0, 0]),
                type: 'origin-label'
            });
            originLabel.setStyle(new ol.style.Style({
                text: new ol.style.Text({
                    text: '0,0',
                    font: 'bold 12px monospace',
                    fill: new ol.style.Fill({ color: 'rgba(251, 191, 36, 1)' }),
                    stroke: new ol.style.Stroke({ color: 'rgba(15, 23, 42, 0.9)', width: 2 }),
                    offsetX: -20,
                    offsetY: 20,
                    textAlign: 'center',
                    textBaseline: 'middle'
                })
            }));
            gridFeatures.push(originLabel);
            
            sources.grid.addFeatures(gridFeatures);
        }
        
        // –°–ª–æ–∏ –∫–∞—Ä—Ç—ã (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏)
        const layers = {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (–≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É)
            grid: new ol.layer.Vector({
                source: sources.grid,
                zIndex: 1
            }),
            
            // RSSI –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º)
            rssiVisualization: new ol.layer.Vector({
                source: sources.coverage,
                style: function(feature) {
                    const rssi = feature.get('rssi') || -100;
                    return mapStyles.rssiZone(rssi);
                },
                zIndex: 40
            }),
            
            // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            trajectories: new ol.layer.Vector({
                source: sources.trajectories,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(59, 130, 246, 0.8)',
                        width: 3,
                        lineDash: [10, 5]
                    })
                }),
                zIndex: 60
            }),
            
            // SDR —Å—Ç–∞–Ω—Ü–∏–∏
            stations: new ol.layer.Vector({
                source: sources.stations,
                style: mapStyles.sdrStation,
                zIndex: 100
            }),
            
            // –î—Ä–æ–Ω—ã
            drones: new ol.layer.Vector({
                source: sources.drones,
                style: mapStyles.drone,
                zIndex: 90
            })
        };
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª—è —Ç—Ä–∏–ª–∞—Ç–µ—Ä–∞—Ü–∏–∏)
        const map = new ol.Map({
            target: 'map',
            layers: [
                layers.grid,
                layers.rssiVisualization,
                layers.trajectories,
                layers.stations,
                layers.drones
            ],
            view: new ol.View({
                projection: projection,
                center: [0, 0], // –û–ø–æ—Ä–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ
                zoom: 15,
                maxZoom: 20,
                minZoom: 12,
                rotation: 0,
                enableRotation: false
            }),
            controls: ol.control.defaults.defaults({
                attribution: false,
                rotate: false
            }).extend([
                new ol.control.ScaleLine({
                    units: 'metric',
                    bar: true,
                    steps: 4,
                    text: true,
                    minWidth: 140
                })
            ])
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        createCoordinateGrid();
        initializeStations();
        initializeRSSIControls();
        
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω—Ü–∏–π ====================
        
        function initializeStations() {
            // –ù–µ —Å–æ–∑–¥–∞—ë–º —Å—Ç–∞–Ω—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Python.
            sources.stations.clear();
            sources.coverage.clear();
        }
        
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====================
        
        function initializeRSSIControls() {
            // –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            console.log('RSSI visualization initialized (detector-controlled)');
        }
        
        // ==================== WebChannel –¥–ª—è —Å–≤—è–∑–∏ —Å Python ====================
        
        let bridge = null;
        
        if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined') {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                bridge = channel.objects.bridge;
                console.log('WebChannel connected');
                
                if (bridge && bridge.dataUpdated) {
                    bridge.dataUpdated.connect(function(data) {
                        handleDataUpdate(JSON.parse(data));
                    });
                }
            });
        }
        
        // ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö ====================
        
        function handleDataUpdate(data) {
            if (data.drones) updateDrones(data.drones);
            if (data.stations) updateStations(data.stations);
            if (data.trajectories) updateTrajectories(data.trajectories);
            if (data.rssiLevels) updateRSSIDisplay(data.rssiLevels);
            updateStats();
        }
        
        function updateDrones(drones) {
            sources.drones.clear();
            
            drones.forEach(drone => {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point([drone.x, drone.y]),
                    id: drone.id,
                    freq: drone.freq,
                    confidence: drone.confidence,
                    rssi: drone.rssi,
                    is_tracked: drone.is_tracked || false
                });
                
                sources.drones.addFeature(feature);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º RSSI –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ñ—É–Ω–∫—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ updateRSSIDisplay)
            
            document.getElementById('active-drones').textContent = drones.length;
            document.getElementById('active-drones').className = 
                drones.length > 0 ? 'status-value danger' : 'status-value';
        }
        
        function updateStations(stations) {
            // –ü–µ—Ä–µ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π: –¥–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ, —á—Ç–æ –ø—Ä–∏—à–ª–∏,
            // —É–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
            const incomingIds = new Set(stations.map(s => s.id));
            // –£–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
            sources.stations.getFeatures().forEach(f => {
                if (!incomingIds.has(f.get('id'))) {
                    sources.stations.removeFeature(f);
                }
            });
            // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º
            stations.forEach(station => {
                let feature = sources.stations.getFeatureById(station.id);
                if (!feature) {
                    feature = new ol.Feature({
                        geometry: new ol.geom.Point([station.x, station.y]),
                        id: station.id,
                        name: station.id,
                        type: 'sdr_station',
                        is_reference: station.id === 'slave0' || station.is_reference,
                        is_active: station.is_active !== false
                    });
                    sources.stations.addFeature(feature);
                } else {
                    feature.getGeometry().setCoordinates([station.x, station.y]);
                    feature.set('is_active', station.is_active !== false);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
            const activeStations = stations.filter(s => s.is_active !== false).length;
            document.getElementById('sdr-stations').textContent = activeStations;
        }
        
        function updateTrajectories(trajectories) {
            sources.trajectories.clear();
            
            trajectories.forEach(traj => {
                const coords = traj.points.map(p => [p.x, p.y]);
                const feature = new ol.Feature({
                    geometry: new ol.geom.LineString(coords),
                    id: traj.id
                });
                sources.trajectories.addFeature(feature);
            });
        }
        
        function updateRSSIDisplay(rssiLevels) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ RSSI –∑–æ–Ω (—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º)
            sources.coverage.clear();
            
            let visibleZones = 0;
            
            rssiLevels.forEach(level => {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Circle([level.x, level.y], level.radius || 50),
                    rssi: level.rssi,
                    radius: level.radius || 50
                });
                
                sources.coverage.addFeature(feature);
                visibleZones++;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö RSSI –∑–æ–Ω
            updateRSSIStats(visibleZones);
        }
        
        function updateRSSIStats(activeZones) {
            const accuracyElement = document.getElementById('trilateration-accuracy');
            if (activeZones >= 3) {
                accuracyElement.textContent = '–í—ã—Å–æ–∫–∞—è';
                accuracyElement.className = 'status-value active';
            } else if (activeZones >= 2) {
                accuracyElement.textContent = '–°—Ä–µ–¥–Ω—è—è';
                accuracyElement.className = 'status-value warning';
            } else {
                accuracyElement.textContent = '–ù–∏–∑–∫–∞—è';
                accuracyElement.className = 'status-value danger';
            }
        }
        
        // ==================== –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ====================
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞
        map.on('pointermove', function(evt) {
            const coords = evt.coordinate;
            document.getElementById('cursor-position').textContent = 
                `X: ${coords[0].toFixed(1)}, Y: ${coords[1].toFixed(1)}`;
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
        map.getView().on('change:resolution', function() {
            const resolution = map.getView().getResolution();
            const scale = Math.round(resolution * 1000);
            document.getElementById('scale-value').textContent = `1:${scale}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏
            let gridSize = 100;
            if (resolution > 10) gridSize = 500;
            if (resolution > 50) gridSize = 1000;
            document.getElementById('grid-size').textContent = `${gridSize}–º`;
        });
        
        // ==================== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ====================
        
        function updateStats() {
            const dronesCount = sources.drones.getFeatures().length;
            const stationsCount = sources.stations.getFeatures().length;
            
            document.getElementById('active-drones').textContent = dronesCount;
            document.getElementById('sdr-stations').textContent = stationsCount;
        }
        
        // FPS —Å—á–µ—Ç—á–∏–∫
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        
        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                document.getElementById('update-rate').textContent = `${frameCount} –ì—Ü`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
            requestAnimationFrame(updateFPS);
        }
        updateFPS();
        
        // ==================== API –¥–ª—è Python ====================
        
        window.mapAPI = {
            updateDrones: updateDrones,
            updateStations: updateStations,
            updateTrajectories: updateTrajectories,
            updateRSSIDisplay: updateRSSIDisplay,
            // –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–±—Ä–∞–Ω—ã - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º
            
            addDrone: function(id, x, y, confidence, rssi) {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point([x, y]),
                    id: id,
                    confidence: confidence,
                    rssi: rssi || -100
                });
                sources.drones.addFeature(feature);
                updateStats();
            },
            
            removeDrone: function(id) {
                const feature = sources.drones.getFeatureById(id);
                if (feature) {
                    sources.drones.removeFeature(feature);
                    updateStats();
                }
            },
            
            clearAll: function() {
                sources.drones.clear();
                sources.trajectories.clear();
                sources.coverage.clear();
                updateStats();
            },
            
            centerOnStation: function(stationId) {
                const view = map.getView();
                const feature = sources.stations.getFeatureById(stationId);
                if (feature) {
                    const coords = feature.getGeometry().getCoordinates();
                    view.animate({ center: coords, zoom: 16, duration: 500 });
                } else {
                    // –§–æ–ª–±—ç–∫: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω–∞—á–∞–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    view.setCenter([0, 0]);
                }
            },
            
            centerOnOrigin: function() {
                const view = map.getView();
                view.animate({ center: [0, 0], duration: 500 });
            },
            
            getMapInfo: function() {
                const view = map.getView();
                return {
                    center: view.getCenter(),
                    zoom: view.getZoom(),
                    resolution: view.getResolution(),
                    extent: view.calculateExtent(map.getSize())
                };
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        console.log('RSSI Trilateration Map initialized');
        
        // –ù–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        if (bridge && bridge._on_map_ready) {
            bridge._on_map_ready();
        }
    </script>
</body>
</html>