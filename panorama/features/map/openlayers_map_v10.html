<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panorama Drone Detection Map - 2D Only</title>
    
    <!-- OpenLayers 10.6.0 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.6.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@10.6.0/dist/ol.js"></script>
    
    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞–º–∏ –∫–∞—Ä—Ç—ã */
        .map-modes {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
        }
        
        .mode-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .mode-button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            margin: 5px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-button:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .mode-button.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ */
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            min-width: 300px;
        }
        
        .coord-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .coord-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .coord-label {
            color: #888;
        }
        
        .coord-value {
            color: #fff;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }
        
        /* –õ–µ–≥–µ–Ω–¥–∞ –¥–ª—è –¥—Ä–æ–Ω–æ–≤ */
        .drone-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* –°—Ç–∞—Ç—É—Å –¥–µ—Ç–µ–∫—Ü–∏–∏ */
        .detection-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            min-width: 250px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .status-label {
            color: #888;
        }
        
        .status-value {
            color: #fff;
            font-weight: 500;
        }
        
        .status-value.active {
            color: #4ade80;
        }
        
        .status-value.warning {
            color: #fbbf24;
        }
        
        .status-value.danger {
            color: #f87171;
        }
        
        /* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞ */
        .cursor-coords {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }
        
        .crosshair {
            position: relative;
            width: 40px;
            height: 40px;
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .crosshair::before {
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 100%;
        }
        
        .crosshair::after {
            top: 50%;
            transform: translateY(-50%);
            height: 1px;
            width: 100%;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –¥—Ä–æ–Ω–∞ */
        @keyframes droneDetected {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(2); opacity: 0.5; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .drone-pulse {
            animation: droneDetected 2s infinite;
        }
        
        /* –†–µ–∂–∏–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã */
        .map-overlay-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ –∫–∞—Ä—Ç—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è) -->
    <div class="map-modes">
        <div class="mode-title">–†–µ–∂–∏–º—ã –∫–∞—Ä—Ç—ã</div>
        <button class="mode-button active" onclick="setMapMode('heatmap')">üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</button>
        <button class="mode-button" onclick="setMapMode('rssi')">üìä RSSI —É—Ä–æ–≤–Ω–∏</button>
    </div>
    
    <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="coordinate-info">
        <div class="coord-title">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
        <div class="coord-item">
            <span class="coord-label">–¶–µ–Ω—Ç—Ä (Slave0):</span>
            <span class="coord-value" id="slave0-coords">X: 0.0, Y: 0.0</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–ú–∞—Å—à—Ç–∞–±:</span>
            <span class="coord-value" id="scale-value">1:1000</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–°–µ—Ç–∫–∞:</span>
            <span class="coord-value" id="grid-size">100–º</span>
        </div>
        <div class="coord-item">
            <span class="coord-label">–ö—É—Ä—Å–æ—Ä:</span>
            <span class="coord-value" id="cursor-position">X: 0, Y: 0</span>
        </div>
    </div>
    
    <!-- –õ–µ–≥–µ–Ω–¥–∞ —Å–∫—Ä—ã—Ç–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é -->
    
    <!-- –°—Ç–∞—Ç—É—Å –¥–µ—Ç–µ–∫—Ü–∏–∏ -->
    <div class="detection-status">
        <div class="mode-title">–°—Ç–∞—Ç—É—Å –¥–µ—Ç–µ–∫—Ü–∏–∏</div>
        <div class="status-item">
            <span class="status-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥—Ä–æ–Ω–æ–≤:</span>
            <span class="status-value danger" id="active-drones">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">SDR —Å—Ç–∞–Ω—Ü–∏–π:</span>
            <span class="status-value active" id="sdr-stations">3</span>
        </div>
        <div class="status-item">
            <span class="status-label">–†–µ–∂–∏–º:</span>
            <span class="status-value" id="current-mode">–î–µ—Ç–µ–∫—Ü–∏—è</span>
        </div>
        <div class="status-item">
            <span class="status-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</span>
            <span class="status-value" id="update-rate">20 –ì—Ü</span>
        </div>
    </div>
    
    <script>
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (2D only) ====================
        
        // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–µ–∫—Ü–∏—é –≤ –º–µ—Ç—Ä–∞—Ö —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ (0,0) –¥–ª—è Slave0
        const projection = new ol.proj.Projection({
            code: 'local-meters',
            units: 'meters',
            extent: [-1000, -1000, 1000, 1000] // 2–∫–º x 2–∫–º –æ–±–ª–∞—Å—Ç—å
        });
        
        // –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let currentMapMode = 'heatmap';
        
        // –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
        const mapStyles = {
            // –°—Ç–∏–ª—å –¥–ª—è SDR —Å—Ç–∞–Ω—Ü–∏–π (Slave0 –≤ —Ü–µ–Ω—Ç—Ä–µ)
            sdrStation: function(feature) {
                const id = feature.get('id') || '';
                const isCenter = id === 'slave0';
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: isCenter ? 15 : 10,
                        fill: new ol.style.Fill({ 
                            color: isCenter ? 'rgba(255, 215, 0, 0.8)' : 'rgba(74, 222, 128, 0.8)' 
                        }),
                        stroke: new ol.style.Stroke({ 
                            color: isCenter ? 'rgba(255, 215, 0, 1)' : 'rgba(74, 222, 128, 1)', 
                            width: isCenter ? 3 : 2 
                        })
                    }),
                    text: new ol.style.Text({
                        text: id.toUpperCase(),
                        font: 'bold 12px sans-serif',
                        fill: new ol.style.Fill({ color: '#ffffff' }),
                        stroke: new ol.style.Stroke({ color: '#000000', width: 3 }),
                        offsetY: -25
                    })
                });
            },
            
            // –°—Ç–∏–ª—å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥—Ä–æ–Ω–æ–≤
            drone: function(feature) {
                const confidence = feature.get('confidence') || 0.5;
                const color = confidence > 0.7 ? '#f87171' : confidence > 0.4 ? '#fbbf24' : '#60a5fa';
                return new ol.style.Style({
                    image: new ol.style.RegularShape({
                        points: 4,
                        radius: 10,
                        radius2: 5,
                        rotation: Math.PI / 4,
                        fill: new ol.style.Fill({ color: color }),
                        stroke: new ol.style.Stroke({ 
                            color: '#ffffff', 
                            width: 2 
                        })
                    }),
                    text: new ol.style.Text({
                        text: `${(confidence * 100).toFixed(0)}%`,
                        font: '11px sans-serif',
                        fill: new ol.style.Fill({ color: '#ffffff' }),
                        offsetY: 20
                    })
                });
            },
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞
            gridStyle: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(255, 255, 255, 0.1)',
                    width: 1,
                    lineDash: [5, 10]
                })
            }),
            
            // –û—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            axisStyle: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(255, 255, 255, 0.3)',
                    width: 2
                })
            })
        };
        
        // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        const sources = {
            stations: new ol.source.Vector(),
            drones: new ol.source.Vector(),
            trajectories: new ol.source.Vector(),
            coverage: new ol.source.Vector(),
            heatmap: new ol.source.Vector(),
            grid: new ol.source.Vector()
        };
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—É—é —Å–µ—Ç–∫—É
        function createCoordinateGrid() {
            const gridFeatures = [];
            const gridStep = 100; // 100 –º–µ—Ç—Ä–æ–≤
            const extent = [-1000, -1000, 1000, 1000];
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let x = extent[0]; x <= extent[2]; x += gridStep) {
                const line = new ol.geom.LineString([[x, extent[1]], [x, extent[3]]]);
                const feature = new ol.Feature({ geometry: line });
                feature.setStyle(x === 0 ? mapStyles.axisStyle : mapStyles.gridStyle);
                gridFeatures.push(feature);
            }
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let y = extent[1]; y <= extent[3]; y += gridStep) {
                const line = new ol.geom.LineString([[extent[0], y], [extent[2], y]]);
                const feature = new ol.Feature({ geometry: line });
                feature.setStyle(y === 0 ? mapStyles.axisStyle : mapStyles.gridStyle);
                gridFeatures.push(feature);
            }
            
            sources.grid.addFeatures(gridFeatures);
        }
        
        // –°–ª–æ–∏ –∫–∞—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ 2D)
        const layers = {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (–≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É)
            grid: new ol.layer.Vector({
                source: sources.grid,
                zIndex: 1
            }),
            
            // –ó–æ–Ω—ã –ø–æ–∫—Ä—ã—Ç–∏—è
            coverage: new ol.layer.Vector({
                source: sources.coverage,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(102, 126, 234, 0.1)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'rgba(102, 126, 234, 0.5)',
                        width: 1,
                        lineDash: [10, 5]
                    })
                }),
                visible: false,
                zIndex: 50
            }),
            
            // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
            trajectories: new ol.layer.Vector({
                source: sources.trajectories,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(96, 165, 250, 0.8)',
                        width: 2,
                        lineDash: [4, 4]
                    })
                }),
                zIndex: 60
            }),
            
            // SDR —Å—Ç–∞–Ω—Ü–∏–∏
            stations: new ol.layer.Vector({
                source: sources.stations,
                style: mapStyles.sdrStation,
                zIndex: 100
            }),
            
            // –î—Ä–æ–Ω—ã
            drones: new ol.layer.Vector({
                source: sources.drones,
                style: mapStyles.drone,
                zIndex: 90
            }),
            
            // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ heatmap)
            heatmap: new ol.layer.Heatmap({
                source: sources.heatmap,
                blur: 15,
                radius: 20,
                weight: function(feature) {
                    return feature.get('confidence') || 0.5;
                },
                visible: false,
                zIndex: 40
            })
        };
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã (—Å—Ç—Ä–æ–≥–æ 2D)
        const map = new ol.Map({
            target: 'map',
            layers: Object.values(layers),
            view: new ol.View({
                projection: projection,
                center: [0, 0], // Slave0 –≤ —Ü–µ–Ω—Ç—Ä–µ
                zoom: 14,
                maxZoom: 18,
                minZoom: 10,
                rotation: 0,
                enableRotation: false // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ 2D
            }),
            controls: ol.control.defaults.defaults({
                attribution: false,
                rotate: false // –û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è
            }).extend([
                new ol.control.ScaleLine({
                    units: 'metric',
                    bar: true,
                    steps: 4,
                    text: true,
                    minWidth: 140
                })
            ])
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        createCoordinateGrid();
        initializeStations();
        
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω—Ü–∏–π ====================
        
        function initializeStations() {
            // –ù–µ —Å–æ–∑–¥–∞—ë–º —Å—Ç–∞–Ω—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Python.
            sources.stations.clear();
            sources.coverage.clear();
        }
        
        // ==================== WebChannel –¥–ª—è —Å–≤—è–∑–∏ —Å Python ====================
        
        let bridge = null;
        
        if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined') {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                bridge = channel.objects.bridge;
                console.log('WebChannel connected');
                
                if (bridge && bridge.dataUpdated) {
                    bridge.dataUpdated.connect(function(data) {
                        handleDataUpdate(JSON.parse(data));
                    });
                }
            });
        }
        
        // ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö ====================
        
        function handleDataUpdate(data) {
            if (data.drones) updateDrones(data.drones);
            if (data.stations) updateStations(data.stations);
            if (data.trajectories) updateTrajectories(data.trajectories);
            if (data.rssiLevels) updateRSSIDisplay(data.rssiLevels);
            updateStats();
        }
        
        function updateDrones(drones) {
            sources.drones.clear();
            
            drones.forEach(drone => {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point([drone.x, drone.y]),
                    id: drone.id,
                    freq: drone.freq,
                    confidence: drone.confidence,
                    rssi: drone.rssi
                });
                
                sources.drones.addFeature(feature);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
                if (currentMapMode === 'heatmap') {
                    sources.heatmap.addFeature(new ol.Feature({
                        geometry: new ol.geom.Point([drone.x, drone.y]),
                        confidence: drone.confidence
                    }));
                }
            });
            
            document.getElementById('active-drones').textContent = drones.length;
            document.getElementById('active-drones').className = 
                drones.length > 0 ? 'status-value danger' : 'status-value';
        }
        
        function updateStations(stations) {
            // –ü–µ—Ä–µ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π: –¥–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ, —á—Ç–æ –ø—Ä–∏—à–ª–∏,
            // —É–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
            const incomingIds = new Set(stations.map(s => s.id));
            // –£–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
            sources.stations.getFeatures().forEach(f => {
                if (!incomingIds.has(f.get('id'))) {
                    sources.stations.removeFeature(f);
                }
            });
            // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º
            stations.forEach(station => {
                let feature = sources.stations.getFeatureById(station.id);
                if (!feature) {
                    feature = new ol.Feature({
                        geometry: new ol.geom.Point([station.x, station.y]),
                        id: station.id,
                        name: station.id,
                        type: 'sdr_station'
                    });
                    sources.stations.addFeature(feature);
                } else {
                    feature.getGeometry().setCoordinates([station.x, station.y]);
                }
            });
        }
        
        function updateTrajectories(trajectories) {
            sources.trajectories.clear();
            
            trajectories.forEach(traj => {
                const coords = traj.points.map(p => [p.x, p.y]);
                const feature = new ol.Feature({
                    geometry: new ol.geom.LineString(coords),
                    id: traj.id
                });
                sources.trajectories.addFeature(feature);
            });
        }
        
        function updateRSSIDisplay(rssiLevels) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π RSSI –¥–ª—è —Ä–µ–∂–∏–º–∞ rssi
            if (currentMapMode === 'rssi') {
                // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —É—Ä–æ–≤–Ω–µ–π RSSI
                sources.coverage.clear();
                
                rssiLevels.forEach(level => {
                    const feature = new ol.Feature({
                        geometry: new ol.geom.Circle([level.x, level.y], level.radius)
                    });
                    
                    const opacity = Math.max(0.1, Math.min(0.8, (level.rssi + 100) / 80));
                    feature.setStyle(new ol.style.Style({
                        fill: new ol.style.Fill({
                            color: `rgba(102, 126, 234, ${opacity})`
                        })
                    }));
                    
                    sources.coverage.addFeature(feature);
                });
            }
        }
        
        // ==================== –†–µ–∂–∏–º—ã –∫–∞—Ä—Ç—ã ====================
        
        function setMapMode(mode) {
            currentMapMode = mode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–ª–æ–µ–≤
            switch(mode) {
                case 'heatmap':
                    layers.drones.setVisible(false);
                    layers.trajectories.setVisible(false);
                    layers.coverage.setVisible(false);
                    layers.heatmap.setVisible(true);
                    document.getElementById('current-mode').textContent = '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞';
                    break;
                
                case 'rssi':
                    layers.drones.setVisible(true);
                    layers.trajectories.setVisible(false);
                    layers.coverage.setVisible(true);
                    layers.heatmap.setVisible(false);
                    document.getElementById('current-mode').textContent = 'RSSI —É—Ä–æ–≤–Ω–∏';
                    break;
            }
        }
        
        // ==================== –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ====================
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞
        map.on('pointermove', function(evt) {
            const coords = evt.coordinate;
            document.getElementById('cursor-position').textContent = 
                `X: ${coords[0].toFixed(1)}, Y: ${coords[1].toFixed(1)}`;
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
        map.getView().on('change:resolution', function() {
            const resolution = map.getView().getResolution();
            const scale = Math.round(resolution * 1000);
            document.getElementById('scale-value').textContent = `1:${scale}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏
            let gridSize = 100;
            if (resolution > 10) gridSize = 500;
            if (resolution > 50) gridSize = 1000;
            document.getElementById('grid-size').textContent = `${gridSize}–º`;
        });
        
        // ==================== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ====================
        
        function updateStats() {
            const dronesCount = sources.drones.getFeatures().length;
            const stationsCount = sources.stations.getFeatures().length;
            
            document.getElementById('active-drones').textContent = dronesCount;
            document.getElementById('sdr-stations').textContent = stationsCount;
        }
        
        // FPS —Å—á–µ—Ç—á–∏–∫
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        
        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                document.getElementById('update-rate').textContent = `${frameCount} –ì—Ü`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
            requestAnimationFrame(updateFPS);
        }
        updateFPS();
        
        // ==================== API –¥–ª—è Python ====================
        
        window.mapAPI = {
            updateDrones: updateDrones,
            updateStations: updateStations,
            updateTrajectories: updateTrajectories,
            updateRSSIDisplay: updateRSSIDisplay,
            setMapMode: setMapMode,
            
            addDrone: function(id, x, y, confidence) {
                const feature = new ol.Feature({
                    geometry: new ol.geom.Point([x, y]),
                    id: id,
                    confidence: confidence
                });
                sources.drones.addFeature(feature);
                updateStats();
            },
            
            removeDrone: function(id) {
                const feature = sources.drones.getFeatureById(id);
                if (feature) {
                    sources.drones.removeFeature(feature);
                    updateStats();
                }
            },
            
            clearAll: function() {
                sources.drones.clear();
                sources.trajectories.clear();
                sources.heatmap.clear();
                updateStats();
            },
            
            centerOnStation: function(stationId) {
                const view = map.getView();
                const feature = sources.stations.getFeatureById(stationId);
                if (feature) {
                    const coords = feature.getGeometry().getCoordinates();
                    view.animate({ center: coords, zoom: 16, duration: 500 });
                } else {
                    // –§–æ–ª–±—ç–∫: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω–∞—á–∞–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    view.setCenter([0, 0]);
                }
            },

            centerOnOrigin: function() {
                const view = map.getView();
                view.animate({ center: [0, 0], duration: 500 });
            },
            
            getMapInfo: function() {
                const view = map.getView();
                return {
                    center: view.getCenter(),
                    zoom: view.getZoom(),
                    resolution: view.getResolution(),
                    extent: view.calculateExtent(map.getSize())
                };
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        console.log('Drone Detection Map 2D initialized');
    </script>
</body>
</html>