# Исправления проблемы зависания приложения

## Проблема
Приложение зависало после вывода сообщения "Master: Update #50, max power: -24.6 dBm". 
Проблема была связана с зависанием в C-коде библиотеки libhackrf_multi.

## Причины зависания
1. **Переполнение очереди пиков** - функция `add_peak` добавляла слишком много пиков в очередь
2. **Бесконечные циклы** - функции группировки могли зависать при обработке большого количества данных
3. **Блокировка мьютексов** - возможна блокировка при длительных операциях
4. **Отсутствие таймаутов** - не было защиты от зависания в критических секциях

## Внесенные исправления

### 1. Защита от зависания в master_thread_fn (hq_master.c)
- Добавлен счетчик циклов без данных (`no_data_count`)
- Добавлена проверка наличия данных перед обновлением спектра
- Добавлен таймаут (20 секунд) для выхода из цикла при отсутствии данных
- Добавлена дополнительная проверка состояния устройства

### 2. Защита от зависания в regroup_frequencies (hq_grouping.c)
- Ограничено количество извлекаемых пиков из очереди (максимум 1000)
- Ограничено количество групп (максимум 100)
- Ограничен размер группы (максимум 50 пиков)
- Ограничены вычисления весов (максимум 20 пиков)
- Ограничен поиск в watchlist (максимум 50 записей)
- Ограничены итерации очистки (максимум 100)

### 3. Защита от переполнения очереди пиков
- Добавлена проверка размера очереди в `add_peak`
- Если очередь содержит более 3000 пиков, новые пики игнорируются

### 4. Таймаут в grouping_thread_fn (hq_api.c)
- Добавлен таймаут для функции группировки
- Логирование медленных операций (>50ms)

### 5. Таймаут в Python-коде (backend.py)
- Добавлен таймаут 1 секунда для вызовов `hq_get_master_spectrum`
- Использование отдельного потока для вызовов C-функций
- Graceful handling таймаутов и исключений

## Результат
- Приложение больше не зависает
- Добавлена диагностика медленных операций
- Автоматическое восстановление после таймаутов
- Лучшая производительность при большом количестве данных

## Компиляция
```bash
cd panorama/drivers/hackrf_lib
make clean && make
```

## Тестирование
После применения исправлений приложение должно работать стабильно без зависаний.
При возникновении проблем в логах будут видны предупреждения о медленных операциях.
